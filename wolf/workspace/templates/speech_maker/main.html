{% extends "base.html" %}


{% block content %}

<h1>SPEECH MAKER</h1>
<button id="play_bulk" type="submit">Play BULK</button>
<br>

{% if instance_name == "" %}
<textarea id="instance_text_area" name="message" rows="1" cols="30"> </textarea>
<button id="save_instance" type="submit">Save Instance</button>

{% else %}
<h2> {{instance_name}} </h2>
{% endif %}

<table id = 'audit_view' border="1">
    <tr  style="background-color: lightblue;">
        <th>RANK/CHAPTER</th>
        <th>AUDIO</th>
        <th>SPEECH/ASR</th>
        <th>TIME</th>
        <th>SPEAKER</th>
        <th>REGENERATE</th>
        <th>DELETE</th>
      </tr>
    
    {% for key, cur_row in content_context.items %}
        {% with key as key  %}
            {% with cur_row as cur_row  %}
                  {% include  "speech_maker/prod_row.html" %}
            {% endwith %}
        {% endwith %}
    {% endfor %}
</table>

<button id="delete_selection" type="submit">Delete Selections</button>

<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

<script>

    function get_now_timestamp() {
        var now = new Date();
        return now.getTime();
    }

    function handle_press_event(event) {
            if (event.keyCode === 17) {
                console.log("Spacebar pressed!");
                table = document.getElementById('audit_view')
                rows = table.getElementsByTagName("tr");
                for (var i =1; i < rows.length; i++)
                {
                    row = rows[i];
                    if(row.querySelector("audio#audio_player").paused)
                        continue;
                    else
                        row.style.backgroundColor = "grey";
                }
            }
        }

    function play_audio(audio_element)
    {
        return new Promise((resolve, reject) => {
            audio_element.play().then(() => {
                audio_element.addEventListener("ended", resolve);
            }).catch(reject);
        });
    };

    async function play_audio_sequentially(audio_elements)
    {
        for (const audio_element of audio_elements)
        {
            await play_audio(audio_element);
        };
    };

    document.getElementById("play_bulk").addEventListener("click", function () {
        this.disabled = true;
        var table = document.getElementById("audit_view")
        var rows = document.getElementsByTagName("tr")

        audio_players = []

        for(var i =1; i< rows.length; i++)
        {
            rows[i].style.backgroundColor = "white";
            audio_players.push(rows[i].querySelector("audio#audio_player"))
        }
        document.addEventListener("keydown", handle_press_event);
        play_audio_sequentially(audio_players).then(() =>{
            document.removeEventListener("keydown", handle_press_event);
            this.disabled = false;
            console.log('All audio files have finished playing.');
        }).catch((error) => {
            console.error('An error occurred during audio playback', error);
        });

    });
</script>

<script>
        save_instance = document.getElementById("save_instance");
        if (save_instance)
        {
            save_instance.addEventListener("click", function () {
            endpoint = "api/save_instance/";
            const filename = document.getElementById("instance_text_area").value;
            const data = {
                filename: filename,
            };
            fetch(endpoint, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },

                body: JSON.stringify({ data }),
            })
                .then((response) => response.json())
                .then((data) => {
                    console.logs("Save success!");
                })
                .catch((error) => {
                    console.log("Error:", error);
                });
         });    
        }  
</script>

<script>
document.getElementById("delete_selection").addEventListener("click", function () {
        this.disabled = true;
        var table = document.getElementById("audit_view")
        var rows = document.getElementsByTagName("tr")

        to_delete = [];

        for(var i =1; i< rows.length; i++)
        {
            rows[i]
            delete_box = rows[i].querySelector("input#delete_button")
            if (delete_box.checked)
            {
                to_delete.push(rows[i].id);
            }
        }
        endpoint = "api/delete_selection/";
        const data = {
            '_ids_': to_delete,
        };

        fetch(endpoint, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                    },
            body: JSON.stringify({ data }),
            })
            .then((response) => response.json())
            .then((data) => {
                location.reload(true)
            })
            .catch((error) => {
                console.log("Error:", error);
            });
        });    


</script>
{% endblock %}
